{{ 'rish-custom.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign autoplay = section.settings.autoplay
  assign show_price = section.settings.show_price
  assign show_add_to_cart = section.settings.show_add_to_cart
  assign show_rating = section.settings.show_rating
  assign add_to_cart_color = section.settings.add_to_cart_color | default: '#008000'
-%}

<div class="rishu-reels-section" 
     style="{% if section.settings.bg_color != blank %}background-color: {{ section.settings.bg_color }};{% endif %}{% if section.settings.bg_image != blank %}background-image: url('{{ section.settings.bg_image | image_url: width: 2000 }}'); background-size: cover; background-position: center;{% endif %}">
  
  <div class="page-width">
    {%- if section.settings.heading != blank -%}
      <h2 class="rishu-reels-heading" style="{% if section.settings.text_color != blank %}color: {{ section.settings.text_color }};{% endif %}">{{ section.settings.heading }}</h2>
    {%- endif -%}

    <div class="rishu-reels-container" id="reels-container-{{ section.id }}">
      {%- for block in section.blocks -%}
        {%- liquid
          assign product = all_products[block.settings.product]
          assign video_url = block.settings.video_url
          assign custom_rating = block.settings.custom_rating
          assign custom_rating_count = block.settings.custom_rating_count
        -%}

          <div class="rishu-reel-card" {{ block.shopify_attributes }}>

          {%- if section.settings.logo != blank -%}
            <div class="rishu-reel-corner-logo rishu-position-{{ section.settings.logo_position }}">
               {{ section.settings.logo | image_url: width: 80 | image_tag: class: 'rishu-reel-logo-img', loading: 'lazy' }}
            </div>
          {%- endif -%}
          {%- comment -%} Reel Content (Video/Image) {%- endcomment -%}
          <div class="rishu-reel-media" 
               onclick="openReelModal('{{ block.id }}', '{{ video_url }}', '{{ product.handle }}', {{ custom_rating | default: 0 }}, {{ custom_rating_count | default: 0 }})"
               onmouseenter="playPreview(this)"
               onmouseleave="pausePreview(this)">
            {%- if video_url != blank -%}
              <video
                class="rishu-reel-video"
                {% if block.settings.image != blank %}poster="{{ block.settings.image | image_url: width: 600 }}"{% endif %}
                muted loop playsinline preload="metadata"
                data-video-url="{{ video_url }}"
              >
                <source src="{{ video_url }}" type="video/mp4">
              </video>
              <div class="play-button-overlay">
                 <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
              </div>
            {%- elsif block.settings.image != blank -%}
              {{ block.settings.image | image_url: width: 600 | image_tag: class: 'rishu-reel-image', loading: 'lazy' }}
            {%- else -%}
              {{ 'image' | placeholder_svg_tag: 'rishu-reel-image rishu-reel-placeholder' }}
            {%- endif -%}
          </div>

          {%- comment -%} Product Info Overlay {%- endcomment -%}
          <div class="rishu-reel-product-overlay">
            {%- if product != blank -%}
              <div class="product-info">
                 <h3 class="product-title">{{ product.title | truncate: 50 }}</h3>
                 {%- if show_price -%}
                    <div class="product-price">
                      {%- if product.compare_at_price > product.price -%}
                        <span class="price-sale">{{ product.price | money }}</span>
                        <span class="price-compare">{{ product.compare_at_price | money }}</span>
                      {%- else -%}
                        <span class="price-regular">{{ product.price | money }}</span>
                      {%- endif -%}
                    </div>
                 {%- endif -%}

                 {%- if show_rating and custom_rating > 0 -%}
                    <div class="product-rating">
                      <div class="rating-stars" data-rating="{{ custom_rating }}">
                        {%- for i in (1..5) -%}
                           <span class="star-icon">★</span>
                        {%- endfor -%}
                      </div>
                      <span class="rating-count">({{ custom_rating_count }})</span>
                    </div>
                 {%- endif -%}

                 {%- if show_add_to_cart -%}
                   <form method="post" action="/cart/add" class="rishu-quick-add-form" onsubmit="event.stopPropagation();">
                     <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                     <button type="submit" class="rishu-btn-add" style="background: {{ add_to_cart_color }};">Add to Cart</button>
                   </form>
                 {%- endif -%}
              </div>
            {%- elsif block.settings.caption != blank -%}
               <div class="product-info">
                 <h3 class="product-title">{{ block.settings.caption }}</h3>
               </div>
            {%- endif -%}
          </div>

        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

<!-- Reel Modal -->
<div id="reel-modal" class="reel-modal" style="display: none;">
  <div class="modal-overlay" onclick="closeReelModal()"></div>
  <div class="modal-content">
    <button class="modal-close" onclick="closeReelModal()">✕</button>
    <div class="modal-video-container">
      <video id="modal-video" controls playsinline loop>
        <source src="" type="video/mp4">
      </video>
    </div>
    <div id="modal-product-info" class="modal-product-info"></div>
  </div>
</div>

<script>
  let currentModal = null;
  let currentVideo = null;

  // Hover Play Logic
  function playPreview(element) {
    if (window.innerWidth <= 990) return; // Disable hover play on mobile
    const video = element.querySelector('video');
    if (video) {
      // Ensure source is loaded if preload was none
      if (video.readyState === 0) video.load(); 
      video.play().catch(e => console.log('Hover play prevented:', e));
    }
  }

  function pausePreview(element) {
    if (window.innerWidth <= 990) return;
    const video = element.querySelector('video');
    if (video) {
        video.pause();
        // Optional: Reset to start? video.currentTime = 0;
    }
  }

  function openReelModal(blockId, videoUrl, productHandle, rating, ratingCount) {
    if (!videoUrl) return; 

    const modal = document.getElementById('reel-modal');
    const modalVideo = document.getElementById('modal-video');
    const modalInfo = document.getElementById('modal-product-info');

    modalVideo.querySelector('source').src = videoUrl;
    modalVideo.load();
    modalVideo.play().catch(e => console.log(e));

    // Fetch product info if handle exists
    if (productHandle && productHandle !== 'null') {
        fetch('/products/' + productHandle + '.js')
        .then(res => res.json())
        .then(product => {
            let priceHtml = '$' + (product.price / 100).toFixed(2);
            let btnHtml = '<button class="rishu-btn-add-modal" onclick="addToCart(' + product.variants[0].id + ')">Add to Cart</button>';
            modalInfo.innerHTML = '<h3>' + product.title + '</h3><div class="modal-price">' + priceHtml + '</div>' + btnHtml;
        });
    } else {
        modalInfo.innerHTML = '';
    }

    modal.style.display = 'flex';
    currentModal = modal;
    currentVideo = modalVideo;
  }

  function closeReelModal() {
    if (currentModal) {
      currentModal.style.display = 'none';
      currentVideo.pause();
    }
  }

  function addToCart(variantId) {
    let formData = {
     'items': [{
      'id': variantId,
      'quantity': 1
      }]
    };
    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(response => {
      alert('Added to cart!');
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }
</script>

{% schema %}
{
  "name": "Rishu Reels",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Watch our Reels"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Corner Logo",
      "info": "Small logo displayed in the corner of the reel"
    },
    {
      "type": "select",
      "id": "logo_position",
      "label": "Logo Position",
      "options": [
        { "value": "top-left", "label": "Top Left" },
        { "value": "top-right", "label": "Top Right" }
      ],
      "default": "top-right"
    },

    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay Videos",
      "default": true
    },
    {
       "type": "checkbox",
       "id": "show_price",
       "label": "Show Price",
       "default": true
    },
    {
       "type": "checkbox",
       "id": "show_add_to_cart",
       "label": "Show Add to Cart",
       "default": true
    },
    {
       "type": "checkbox",
       "id": "show_rating",
       "label": "Show Ratings",
       "default": true
    },
    {
      "type": "color",
      "id": "add_to_cart_color",
      "label": "Add to Cart Color",
      "default": "#008000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color"
    },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background Image"
    }
  ],
  "blocks": [
    {
      "type": "reel",
      "name": "Reel Card",
      "settings": [
        {
           "type": "product",
           "id": "product",
           "label": "Select Product"
        },
        {
          "type": "url",
          "id": "video_url",
          "label": "Video URL (MP4)",
          "info": "Upload file to Settings > Files and paste link here"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Poster Image (9:16)"
        },
        {
          "type": "text",
          "id": "caption",
          "label": "Caption (if no product)"
        },
        {
          "type": "range",
          "id": "custom_rating",
          "label": "Rating",
          "min": 0,
          "max": 5,
          "step": 0.1,
          "default": 4.5
        },
        {
          "type": "number",
          "id": "custom_rating_count",
          "label": "Review Count",
          "default": 10
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Rishu Reels",
      "blocks": [
        { "type": "reel" },
        { "type": "reel" },
        { "type": "reel" }
      ]
    }
  ]
}
{% endschema %}
