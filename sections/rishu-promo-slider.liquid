{%- liquid
  assign section_id = section.id
  assign autoplay = section.settings.autoplay
  assign autoplay_speed = section.settings.autoplay_speed
  assign show_arrows = section.settings.show_arrows
  assign show_dots = section.settings.show_dots
  assign slide_height = section.settings.slide_height
  assign bg_color = section.settings.bg_color
-%}

<div
  class="rishu-promo-slider-section"
  style="{% if bg_color != blank %}background-color: {{ bg_color }};{% endif %}"
  data-autoplay="{{ autoplay }}"
  data-speed="{{ autoplay_speed }}"
  data-slide-height="{{ slide_height }}"
>
  <div class="rishu-promo-slider page-width">
    <div class="rishu-promo-slides">
      {%- for block in section.blocks -%}
        {%- case block.type -%}
          {%- when 'slide' -%}
            <div
              class="rishu-promo-slide {% if forloop.first %}active{% endif %}"
              data-slide-index="{{ forloop.index0 }}"
              {{ block.shopify_attributes }}
            >
              {%- if block.settings.link != blank -%}
                <a href="{{ block.settings.link }}" class="rishu-promo-slide-link" aria-label="{{ block.settings.image.alt | default: 'View' }}"></a>
              {%- endif -%}

              {%- if block.settings.image != blank -%}
                <picture class="rishu-promo-picture">
                  {%- if block.settings.mobile_image != blank -%}
                    <source
                      media="(max-width: 749px)"
                      srcset="
                        {{ block.settings.mobile_image | image_url: width: 600 }} 600w,
                        {{ block.settings.mobile_image | image_url: width: 800 }} 800w,
                        {{ block.settings.mobile_image | image_url: width: 1200 }} 1200w
                      "
                      sizes="100vw"
                    >
                  {%- endif -%}
                  {%- if forloop.first -%}
                    {{
                      block.settings.image
                      | image_url: width: 2400
                      | image_tag:
                        loading: 'eager',
                        fetchpriority: 'high',
                        width: block.settings.image.width,
                        height: block.settings.image.height,
                        alt: block.settings.image.alt | default: block.settings.heading,
                        class: 'rishu-promo-image',
                        sizes: '100vw',
                        widths: '375, 550, 750, 1100, 1500, 1780, 2000, 2400'
                    }}
                  {%- else -%}
                    {{
                      block.settings.image
                      | image_url: width: 2400
                      | image_tag:
                        loading: 'lazy',
                        fetchpriority: 'low',
                        width: block.settings.image.width,
                        height: block.settings.image.height,
                        alt: block.settings.image.alt | default: block.settings.heading,
                        class: 'rishu-promo-image',
                        sizes: '100vw',
                        widths: '375, 550, 750, 1100, 1500, 1780, 2000, 2400'
                    }}
                  {%- endif -%}
                </picture>
              {%- else -%}
                <div class="rishu-promo-placeholder">
                  {{ 'lifestyle-1' | placeholder_svg_tag: 'rishu-promo-placeholder-svg' }}
                </div>
              {%- endif -%}
            </div>
        {%- endcase -%}
      {%- endfor -%}
    </div>

    {%- if section.blocks.size > 1 -%}
      {%- if show_arrows -%}
        <div class="rishu-promo-arrows">
          <button type="button" class="rishu-promo-arrow rishu-promo-arrow-prev" aria-label="Previous slide">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <button type="button" class="rishu-promo-arrow rishu-promo-arrow-next" aria-label="Next slide">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      {%- endif -%}

      {%- if show_dots -%}
        <div class="rishu-promo-dots">
          {%- for block in section.blocks -%}
            {%- if block.type == 'slide' -%}
              <button
                type="button"
                class="rishu-promo-dot {% if forloop.first %}active{% endif %}"
                data-slide="{{ forloop.index0 }}"
                aria-label="Go to slide {{ forloop.index }}"
              ></button>
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- endif -%}
    {%- endif -%}
  </div>
</div>

<script>
  (function() {
    function initPromoSliders() {
      document.querySelectorAll('.rishu-promo-slider-section').forEach(function(section) {
        var slider = section.querySelector('.rishu-promo-slider');
        var slides = slider ? slider.querySelectorAll('.rishu-promo-slide') : [];
        var dots = section.querySelectorAll('.rishu-promo-dot');
        var prevBtn = section.querySelector('.rishu-promo-arrow-prev');
        var nextBtn = section.querySelector('.rishu-promo-arrow-next');
        if (slides.length <= 1) return;

        var currentIndex = 0;
        var autoplay = section.dataset.autoplay === 'true';
        var speed = parseInt(section.dataset.speed, 10) * 1000 || 5000;
        var autoplayTimer = null;

        function goToSlide(index) {
          if (index === currentIndex) return;
          var prev = currentIndex;
          currentIndex = index;
          slides[prev].classList.remove('active');
          slides[currentIndex].classList.add('active');
          dots.forEach(function(dot, i) {
            dot.classList.toggle('active', i === currentIndex);
          });
          if (autoplay) {
            clearInterval(autoplayTimer);
            autoplayTimer = setInterval(next, speed);
          }
        }
        function next() {
          goToSlide((currentIndex + 1) % slides.length);
        }
        function prev() {
          goToSlide((currentIndex - 1 + slides.length) % slides.length);
        }

        prevBtn && prevBtn.addEventListener('click', prev);
        nextBtn && nextBtn.addEventListener('click', next);
        dots.forEach(function(dot, index) {
          dot.addEventListener('click', function() { goToSlide(index); });
        });

        var startX = 0;
        section.addEventListener('touchstart', function(e) { startX = e.touches[0].clientX; }, { passive: true });
        section.addEventListener('touchend', function(e) {
          var endX = e.changedTouches[0].clientX;
          if (Math.abs(startX - endX) > 50) (startX > endX) ? next() : prev();
        }, { passive: true });

        if (autoplay) {
          autoplayTimer = setInterval(next, speed);
          section.addEventListener('mouseenter', function() { clearInterval(autoplayTimer); });
          section.addEventListener('mouseleave', function() { autoplayTimer = setInterval(next, speed); });
        }
      });
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPromoSliders);
    } else {
      initPromoSliders();
    }
  })();
</script>

{% schema %}
{
  "name": "Promo / Ad Slider",
  "tag": "section",
  "class": "rishu-promo-slider-section-wrapper",
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#f5f5f5"
    },
    {
      "type": "select",
      "id": "slide_height",
      "label": "Slide height",
      "options": [
        { "value": "auto", "label": "Auto (image height)" },
        { "value": "50vh", "label": "Small (50vh)" },
        { "value": "60vh", "label": "Medium (60vh)" },
        { "value": "70vh", "label": "Large (70vh)" },
        { "value": "80vh", "label": "Extra large (80vh)" }
      ],
      "default": "auto",
      "info": "Auto uses the image's aspect ratio; good for full-width ad images."
    },
    {
      "type": "header",
      "content": "Slider"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-rotate slides",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Change slides every",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "default": 5
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show dots",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Recommended: 1920×1080 or 1200×600 for best display on desktop and mobile."
        },
        {
          "type": "image_picker",
          "id": "mobile_image",
          "label": "Mobile image (optional)",
          "info": "Use a different image on small screens (e.g. taller crop)."
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading (for accessibility)",
          "info": "Used as alt text if image alt is empty."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Promo / Ad Slider",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
